<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedidos - Studio Erika Daiany</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bibliotecas PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Ícones (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animação de erro */
        .flash-error { animation: flash-border 0.5s ease-out; }
        @keyframes flash-border {
            0% { border-color: #ef4444; box-shadow: 0 0 4px #ef4444; }
            100% { border-color: #d1d5db; box-shadow: none; }
        }

        /* Estilo da Scrollbar */
        .modal-scroll::-webkit-scrollbar { width: 8px; }
        .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Cabeçalho / Navegação -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="ph ph-shopping-cart text-blue-600 text-2xl mr-2"></i>
                    <h1 class="text-xl font-bold text-gray-800">Studio Erika Daiany</h1>
                </div>
                <nav class="flex space-x-4">
                    <button onclick="switchTab('new-order')" id="tab-btn-new-order" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-100 text-blue-700">
                        Novo Pedido
                    </button>
                    <button onclick="switchTab('history')" id="tab-btn-history" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                        Histórico
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">

        <!-- ABA: NOVO PEDIDO -->
        <div id="tab-new-order" class="space-y-6">
            
            <!-- Busca -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="ph ph-magnifying-glass text-gray-400"></i>
                    </div>
                    <input type="text" id="search-input" 
                           class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="Buscar produto (ex: Shampoo, 8.1, Pó)...">
                </div>
            </div>

            <!-- Mensagem de Erro -->
            <div id="message-box" class="hidden p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded-md shadow-sm flex items-start">
                <i class="ph ph-warning-circle text-xl mr-2 mt-0.5"></i>
                <div>
                    <h4 class="font-bold text-sm">Atenção</h4>
                    <p id="message-content" class="text-sm mt-1"></p>
                </div>
            </div>

            <!-- Listas de Produtos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Coluna Profissional -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 h-fit">
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="ph ph-briefcase mr-2 text-blue-600"></i> Linha Profissional
                        </h2>
                        <span class="text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-1 rounded-full" id="count-prof">0 itens</span>
                    </div>
                    <div id="professional-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2 modal-scroll"></div>
                </div>

                <!-- Coluna Home Care -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 h-fit">
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="ph ph-house mr-2 text-green-600"></i> Linha Home Care
                        </h2>
                        <span class="text-xs font-semibold bg-gray-100 text-gray-600 px-2 py-1 rounded-full" id="count-home">0 itens</span>
                    </div>
                    <div id="homecare-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2 modal-scroll"></div>
                </div>
            </div>

            <!-- Barra Inferior Fixa -->
            <div class="sticky bottom-4 mx-auto max-w-7xl">
                <div class="bg-gray-900 text-white p-4 rounded-xl shadow-2xl flex flex-col md:flex-row justify-between items-center gap-4 border border-gray-700">
                    <div class="flex flex-col">
                        <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold">Total do Pedido</span>
                        <span id="total-price" class="text-3xl font-bold text-white">R$ 0,00</span>
                    </div>
                    <div class="flex gap-3 w-full md:w-auto">
                        <button id="clear-order-btn" class="flex-1 md:flex-none px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition flex items-center justify-center gap-2">
                            <i class="ph ph-trash"></i> Limpar
                        </button>
                        <button id="preview-pdf-btn" class="flex-1 md:flex-none px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                            <i class="ph ph-check-circle"></i> Conferir Pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA: HISTÓRICO -->
        <div id="tab-history" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Histórico de Pedidos</h2>
                    <button onclick="clearHistory()" class="text-red-600 hover:text-red-800 text-sm font-medium flex items-center">
                        <i class="ph ph-trash mr-1"></i> Limpar Histórico
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mês Ref.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Itens</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-history-msg" class="hidden text-center py-10 text-gray-500 italic">
                    Nenhum pedido salvo no histórico.
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL DE CONFERÊNCIA E ENVIO -->
    <div id="preview-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            
            <!-- Background Overlay -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <!-- Modal Panel -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start flex-col">
                        <div class="w-full flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 flex items-center gap-2" id="modal-title">
                                <i class="ph ph-file-pdf text-red-500 text-xl"></i> Conferência do Pedido
                            </h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-500">
                                <i class="ph ph-x text-2xl"></i>
                            </button>
                        </div>
                        
                        <!-- Link para abrir externo (Ajuda no Mobile) -->
                        <div class="w-full flex justify-end mb-2">
                            <a id="external-pdf-link" href="#" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1 font-medium">
                                <i class="ph ph-arrows-out-simple"></i> Visualizar em Tela Cheia
                            </a>
                        </div>

                        <!-- Área de Preview do PDF -->
                        <div class="w-full h-[70vh] md:h-[500px] bg-gray-100 rounded-lg border border-gray-300 flex items-center justify-center relative overflow-hidden">
                            <iframe id="pdf-preview-frame" class="w-full h-full rounded-lg" title="PDF Preview"></iframe>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 text-blue-800 text-sm rounded-md border border-blue-200">
                            <p class="flex items-start gap-2">
                                <i class="ph ph-info mt-0.5 font-bold"></i>
                                <span><strong>Dica:</strong> No celular, ao clicar em "Enviar", escolha o WhatsApp na lista e o PDF será anexado automaticamente. No computador, o PDF será baixado e você poderá arrastá-lo para a conversa.</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <!-- Botão Inteligente de Compartilhamento -->
                    <button type="button" id="btn-share-smart" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm items-center gap-2">
                        <i class="ph ph-share-network text-lg"></i> Enviar Pedido (WhatsApp/Email)
                    </button>
                    
                    <button type="button" id="btn-download-only" class="w-full mt-2 sm:mt-0 inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm items-center gap-2">
                        <i class="ph ph-download-simple text-lg"></i> Baixar
                    </button>
                    <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS DO CLIENTE E SISTEMA ---
        const WHATSAPP_NUMBER = "5545988297306"; 
        const CONTACT_NAME = "Alessandra";
        
        // --- DADOS DOS PRODUTOS ---
        // ATENÇÃO: Adicionei a propriedade 'multiVariant: true' apenas para as tinturas solicitadas.
        const produtosProfissionais = [
            { name: "Pó Air Libre 500g", price: 131.48, category: "Profissional", needsCode: false },
            { name: "Pó Blanc Blond 500g", price: 131.48, category: "Profissional", needsCode: false },
            { name: "8x Powder 200g", price: 331.48, category: "Profissional", needsCode: false },
            { name: "Água Oxigenada 950ml", price: 69.21, category: "Profissional", needsCode: true }, 
            { name: "9 Ampolas Hydra Color 17ml", price: 152.99, category: "Profissional", needsCode: false },
            
            // --- PRODUTOS MODIFICADOS PARA MÚLTIPLAS CORES ---
            { name: "Truss Color Permanente 60g", price: 30.29, category: "Profissional", needsCode: true, multiVariant: true },
            { name: "Truss Color Semipermanente 60g", price: 30.29, category: "Profissional", needsCode: true, multiVariant: true },
            // ------------------------------------------------
            
            { name: "Color Perfect Blond Matizador 60g", price: 34.97, category: "Profissional", needsCode: true },
            { name: "Skin Protector 50g", price: 51.00, category: "Profissional", needsCode: false },
            { name: "Papel Sustentável 120 fls", price: 38.90, category: "Profissional", needsCode: false },
            { name: "Infusion Profissional 650ml", price: 318.73, category: "Profissional", needsCode: false },
            { name: "K Recovery 650ml", price: 458.98, category: "Profissional", needsCode: false },
            { name: "Scrub Therapy 170g", price: 199.98, category: "Profissional", needsCode: false },
            { name: "Bidimensional 1L", price: 203.99, category: "Profissional", needsCode: false },
            { name: "No Metal 1L", price: 203.99, category: "Profissional", needsCode: false },
            { name: "Clarifying 1L", price: 203.99, category: "Profissional", needsCode: false },
            { name: "Lipidic 650ml", price: 293.25, category: "Profissional", needsCode: false },
            { name: "Proteic 650ml", price: 293.25, category: "Profissional", needsCode: false },
            { name: "Deep Reconstruction 500ml", price: 369.74, category: "Profissional", needsCode: false },
            { name: "Intesive Nutrition 1L", price: 216.75, category: "Profissional", needsCode: false },
            { name: "Protector Plus 650ml", price: 201.93, category: "Profissional", needsCode: false },
            { name: "Volume Therapy 650ml", price: 206.54, category: "Profissional", needsCode: false },
            { name: "Acid Anti-Breakage 400ml", price: 299.99, category: "Profissional", needsCode: false },
            { name: "Shampoo Bidimensional (Pouch) 1L", price: 173.41, category: "Profissional", needsCode: false },
            { name: "Shampoo Basic 2,4L", price: 216.71, category: "Profissional", needsCode: false },
            { name: "Condicionador Basic 2,4L", price: 229.49, category: "Profissional", needsCode: false },
        ];

        const produtosHomeCare = [
            { name: "Shampoo Equilibrium 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Infusion 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Ultra Hydration 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Ultra Hydration Plus 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Blond 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Miracle 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Miracle Summer 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Structure 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Color 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Curly 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Shampoo Perfect 300ml", price: 88.02, category: "Home Care", needsCode: false },
            { name: "Condicionador Equilibrium 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Infusion 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Ultra Hydration 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Ultra Hydration Plus 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Blond 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Miracle 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Miracle Summer 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Structure 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Color 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Curly 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Condicionador Perfect 300ml", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Mask Miracle 180g", price: 127.99, category: "Home Care", needsCode: false },
            { name: "Mask Miracle Summer 180g", price: 127.99, category: "Home Care", needsCode: false },
            { name: "Mask Blond 180g", price: 127.99, category: "Home Care", needsCode: false },
            { name: "Mask Specific 180g", price: 127.99, category: "Home Care", needsCode: false },
            { name: "Mask Perfect 180g", price: 127.99, category: "Home Care", needsCode: false },
            { name: "Mask Uso Obrigatório 180g", price: 127.99, category: "Home Care", needsCode: false },
            { name: "Mask Uso Obrigatório Plus+ 180g", price: 127.99, category: "Home Care", needsCode: false },
            { name: "Net Mask 550g", price: 239.99, category: "Home Care", needsCode: false },
            { name: "Net Mask Blond Revolution 550g", price: 129.90, category: "Home Care", needsCode: false },
            { name: "Friz.zerro", price: 127.48, category: "Home Care", needsCode: false },
            { name: "Hair Protector", price: 127.48, category: "Home Care", needsCode: false },
            { name: "Day by Day", price: 103.99, category: "Home Care", needsCode: false },
            { name: "Body & Volume", price: 103.99, category: "Home Care", needsCode: false },
            { name: "Brush Keratin", price: 103.99, category: "Home Care", needsCode: false },
            { name: "Curly Light", price: 103.99, category: "Home Care", needsCode: false },
            { name: "Curly Fix", price: 103.99, category: "Home Care", needsCode: false },
            { name: "Beach Waves", price: 128.00, category: "Home Care", needsCode: false },
            { name: "Fluid Fix", price: 100.78, category: "Home Care", needsCode: false },
            { name: "Amino", price: 183.97, category: "Home Care", needsCode: false },
            { name: "Night Spa", price: 135.99, category: "Home Care", needsCode: false },
            { name: "#CrazyForTruss", price: 167.99, category: "Home Care", needsCode: false },
            { name: "Shock Repair 4 ampolas", price: 95.99, category: "Home Care", needsCode: false },
            { name: "Spray Uso Obrigatório 260ml", price: 159.99, category: "Home Care", needsCode: false },
            { name: "Spray Uso Obrigatório Plus+ 260ml", price: 159.99, category: "Home Care", needsCode: false },
        ];
        
        let productState = { "Profissional": [], "Home Care": [] };
        let currentPdfDoc = null; 

        // --- REFERÊNCIAS DOM ---
        const elements = {
            profList: document.getElementById('professional-list'),
            homeList: document.getElementById('homecare-list'),
            container: document.getElementById('product-lists-container'),
            totalPrice: document.getElementById('total-price'),
            previewBtn: document.getElementById('preview-pdf-btn'),
            clearBtn: document.getElementById('clear-order-btn'),
            messageBox: document.getElementById('message-box'),
            messageContent: document.getElementById('message-content'),
            countProf: document.getElementById('count-prof'),
            countHome: document.getElementById('count-home'),
            searchInput: document.getElementById('search-input'),
            tabNewOrder: document.getElementById('tab-new-order'),
            tabHistory: document.getElementById('tab-history'),
            tabBtnNew: document.getElementById('tab-btn-new-order'),
            tabBtnHist: document.getElementById('tab-btn-history'),
            historyTable: document.getElementById('history-table-body'),
            emptyHistoryMsg: document.getElementById('empty-history-msg'),
            modal: document.getElementById('preview-modal'),
            modalFrame: document.getElementById('pdf-preview-frame'),
            btnShareSmart: document.getElementById('btn-share-smart'),
            btnDownloadOnly: document.getElementById('btn-download-only'),
            mobilePlaceholder: document.getElementById('mobile-pdf-placeholder'),
            externalPdfLink: document.getElementById('external-pdf-link')
        };

        // --- SISTEMA DE ABAS ---
        window.switchTab = function(tabName) {
            if (tabName === 'new-order') {
                elements.tabNewOrder.classList.remove('hidden');
                elements.tabHistory.classList.add('hidden');
                elements.tabBtnNew.classList.replace('text-gray-500', 'text-blue-700');
                elements.tabBtnNew.classList.replace('bg-gray-50', 'bg-blue-100');
                elements.tabBtnHist.classList.replace('text-blue-700', 'text-gray-500');
                elements.tabBtnHist.classList.replace('bg-blue-100', 'bg-gray-50');
            } else {
                elements.tabNewOrder.classList.add('hidden');
                elements.tabHistory.classList.remove('hidden');
                elements.tabBtnHist.classList.replace('text-gray-500', 'text-blue-700');
                elements.tabBtnHist.classList.replace('bg-gray-50', 'bg-blue-100');
                elements.tabBtnNew.classList.replace('text-blue-700', 'text-gray-500');
                elements.tabBtnNew.classList.replace('bg-blue-100', 'bg-gray-50');
                renderHistory();
            }
        };

        // --- FUNÇÕES DE FORMATAÇÃO E UI ---
        const formatCurrency = val => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const showError = msg => { elements.messageContent.textContent = msg; elements.messageBox.classList.remove('hidden'); };
        const hideError = () => elements.messageBox.classList.add('hidden');
        const getCurrentMonth = () => {
            const m = new Date().toLocaleString('pt-BR', { month: 'long' });
            return m.charAt(0).toUpperCase() + m.slice(1);
        };

        // --- INICIALIZAÇÃO DE DADOS ---
        function initializeState() {
            const sortFn = (a, b) => a.name.localeCompare(b.name);
            productState["Profissional"] = produtosProfissionais.sort(sortFn).map(p => ({ 
                ...p, 
                quantity: 0, 
                code: '',
                variants: p.multiVariant ? [] : undefined // Inicializa array para variantes se for o caso
            }));
            productState["Home Care"] = produtosHomeCare.sort(sortFn).map(p => ({ ...p, quantity: 0, code: '' }));
        }

        // --- RENDERIZAÇÃO DE LISTAS ---
        function renderLists(filter = '') {
            elements.profList.innerHTML = '';
            elements.homeList.innerHTML = '';
            hideError();

            const fText = filter.toLowerCase();
            const filterFn = p => p.name.toLowerCase().includes(fText) || p.code.includes(fText);

            const listProf = productState["Profissional"].filter(filterFn);
            const listHome = productState["Home Care"].filter(filterFn);

            listProf.forEach(p => elements.profList.appendChild(createCard(p)));
            listHome.forEach(p => elements.homeList.appendChild(createCard(p)));

            elements.countProf.textContent = `${listProf.length} itens`;
            elements.countHome.textContent = `${listHome.length} itens`;

            if (listProf.length === 0) elements.profList.innerHTML = '<p class="text-gray-400 italic text-sm">Nenhum produto encontrado.</p>';
            if (listHome.length === 0) elements.homeList.innerHTML = '<p class="text-gray-400 italic text-sm">Nenhum produto encontrado.</p>';
        }

        function createCard(product) {
            const card = document.createElement('div');
            
            // Lógica Diferente para Produtos "Multi-Variação" (Tinturas)
            if (product.multiVariant) {
                const isActive = product.variants.length > 0;
                card.className = `p-3 rounded-lg border transition-all duration-200 flex flex-col justify-between ${isActive ? 'bg-blue-50 border-blue-300 shadow-md' : 'bg-white border-gray-100 hover:border-blue-200'}`;
                
                let variantsListHTML = '';
                if(product.variants.length > 0) {
                    variantsListHTML = '<div class="mt-3 bg-white rounded border border-gray-200 divide-y divide-gray-100">';
                    product.variants.forEach((v, idx) => {
                        variantsListHTML += `
                            <div class="flex justify-between items-center p-2 text-sm">
                                <span><span class="font-bold text-gray-700">${v.quantity}x</span> Cor: ${v.code}</span>
                                <button class="text-red-500 hover:text-red-700 p-1 remove-variant-btn" data-index="${idx}">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                    variantsListHTML += '</div>';
                }

                card.innerHTML = `
                    <div class="mb-2">
                        <div class="flex justify-between items-start gap-2">
                            <span class="text-sm font-bold text-gray-800 leading-tight">${product.name}</span>
                            <span class="text-xs font-bold text-gray-600 bg-gray-100 px-1.5 py-0.5 rounded">${formatCurrency(product.price)}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 items-end mt-1">
                        <div class="flex-grow">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Numeração/Cor</label>
                            <input type="text" class="variant-code-input w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Ex: 7.0">
                        </div>
                        <div class="w-16">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Qtd</label>
                            <input type="number" min="1" value="1" class="variant-qty-input w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-center">
                        </div>
                        <button class="add-variant-btn h-[34px] px-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition flex items-center justify-center">
                            <i class="ph ph-plus font-bold"></i>
                        </button>
                    </div>
                    
                    ${variantsListHTML}
                `;

                // Event Listeners para Multi-Variant
                const addBtn = card.querySelector('.add-variant-btn');
                const codeInput = card.querySelector('.variant-code-input');
                const qtyInput = card.querySelector('.variant-qty-input');

                addBtn.addEventListener('click', () => {
                    const code = codeInput.value.trim();
                    const qty = parseInt(qtyInput.value);

                    if (!code) {
                        codeInput.classList.add('flash-error');
                        return;
                    }
                    if (qty <= 0) return;

                    product.variants.push({ code: code, quantity: qty });
                    // Limpa inputs
                    codeInput.value = '';
                    qtyInput.value = '1';
                    codeInput.focus();
                    
                    // Re-renderiza o card para mostrar a lista atualizada
                    card.replaceWith(createCard(product));
                    updateTotal();
                });

                // Remover Variantes
                card.querySelectorAll('.remove-variant-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = parseInt(e.currentTarget.dataset.index);
                        product.variants.splice(idx, 1);
                        card.replaceWith(createCard(product));
                        updateTotal();
                    });
                });

            } else {
                // --- Lógica Padrão para outros produtos ---
                const isActive = product.quantity > 0;
                card.className = `p-3 rounded-lg border transition-all duration-200 flex flex-col justify-between ${isActive ? 'bg-blue-50 border-blue-300 shadow-md transform scale-[1.01]' : 'bg-white border-gray-100 hover:border-blue-200'}`;
                
                card.dataset.name = product.name;
                card.dataset.category = product.category;

                const codeInput = product.needsCode ? `
                    <div class="mt-2 mb-1">
                        <input type="text" class="color-code-input w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none" 
                            placeholder="Digite Cor/Vol" value="${product.code}">
                    </div>` : '';

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start gap-2">
                            <span class="text-sm font-medium text-gray-800 leading-tight">${product.name}</span>
                            <span class="text-xs font-bold text-gray-600 bg-gray-100 px-1.5 py-0.5 rounded">${formatCurrency(product.price)}</span>
                        </div>
                        ${codeInput}
                    </div>
                    <div class="flex items-center justify-end mt-3 gap-2">
                        <button class="qty-btn w-7 h-7 rounded border flex items-center justify-center bg-white hover:bg-red-50 hover:text-red-500 transition" data-action="dec">
                            <i class="ph ph-minus font-bold text-xs"></i>
                        </button>
                        <span class="qty-display w-6 text-center font-bold text-gray-800">${product.quantity}</span>
                        <button class="qty-btn w-7 h-7 rounded border flex items-center justify-center bg-white hover:bg-green-50 hover:text-green-600 transition" data-action="inc">
                            <i class="ph ph-plus font-bold text-xs"></i>
                        </button>
                    </div>
                `;
                
                card.querySelectorAll('.qty-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.currentTarget.dataset.action;
                        updateQuantity(product, action, card);
                    });
                });

                const input = card.querySelector('.color-code-input');
                if(input) {
                    input.addEventListener('input', (e) => {
                        product.code = e.target.value;
                        if(product.code && product.quantity > 0) hideError();
                        updateTotal();
                    });
                }
            }

            return card;
        }

        // --- LÓGICA DE ATUALIZAÇÃO ---
        function updateQuantity(product, action, cardEl) {
            if (action === 'inc') {
                if (product.needsCode && !product.code) {
                    const input = cardEl.querySelector('.color-code-input');
                    input.classList.add('flash-error');
                    input.focus();
                    setTimeout(() => input.classList.remove('flash-error'), 500);
                }
                product.quantity++;
            } else if (action === 'dec' && product.quantity > 0) {
                product.quantity--;
            }
            
            cardEl.querySelector('.qty-display').textContent = product.quantity;
            if (product.quantity > 0) {
                cardEl.classList.remove('bg-white', 'border-gray-100');
                cardEl.classList.add('bg-blue-50', 'border-blue-300', 'shadow-md', 'scale-[1.01]');
            } else {
                cardEl.classList.add('bg-white', 'border-gray-100');
                cardEl.classList.remove('bg-blue-50', 'border-blue-300', 'shadow-md', 'scale-[1.01]');
            }
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            const all = [...productState["Profissional"], ...productState["Home Care"]];
            
            all.forEach(p => {
                if (p.multiVariant) {
                    // Soma das variantes
                    const variantsTotalQty = p.variants.reduce((acc, v) => acc + v.quantity, 0);
                    total += p.price * variantsTotalQty;
                } else {
                    // Lógica padrão
                    if (p.quantity > 0 && (!p.needsCode || (p.needsCode && p.code))) {
                        total += p.price * p.quantity;
                    }
                }
            });
            elements.totalPrice.textContent = formatCurrency(total);
        }

        function clearOrder() {
            if(!confirm("Tem certeza que deseja limpar todo o pedido?")) return;
            initializeState();
            elements.searchInput.value = '';
            renderLists();
            updateTotal();
        }

        // Recupera o pedido em formato "plano" para o PDF
        function getActiveOrder() {
            const all = [...productState["Profissional"], ...productState["Home Care"]];
            let flatItems = [];
            let invalid = [];

            all.forEach(p => {
                if (p.multiVariant) {
                    // Adiciona cada variante como um item separado na lista final
                    if (p.variants.length > 0) {
                        p.variants.forEach(v => {
                            flatItems.push({
                                name: p.name,
                                price: p.price,
                                code: v.code,
                                quantity: v.quantity
                            });
                        });
                    }
                } else {
                    if (p.quantity > 0) {
                        if (p.needsCode && !p.code) {
                            invalid.push(p);
                        } else {
                            flatItems.push({
                                name: p.name,
                                price: p.price,
                                code: p.code,
                                quantity: p.quantity
                            });
                        }
                    }
                }
            });
            
            return { items: flatItems, invalid };
        }

        // --- GERAÇÃO DE PDF E PREVIEW ---
        function preparePdf() {
            hideError();
            const { items, invalid } = getActiveOrder();

            if (invalid.length > 0) {
                showError(`Faltando código/cor em: ${invalid.map(i => i.name).join(', ')}`);
                return null;
            }
            if (items.length === 0) {
                showError("O pedido está vazio.");
                return null;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const month = getCurrentMonth();
            const today = new Date().toLocaleDateString('pt-BR');

            // Cabeçalho
            doc.setFillColor(30, 58, 138); 
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text("PEDIDO STUDIO ERIKA DAIANY", pageWidth / 2, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Data: ${today}  |  Mês de Referência: ${month}`, pageWidth / 2, 30, { align: 'center' });

            // Tabela
            const tableRows = items.map(item => [
                item.name,
                item.code || '-',
                item.quantity,
                formatCurrency(item.price),
                formatCurrency(item.price * item.quantity)
            ]);

            let totalOrder = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);

            doc.autoTable({
                head: [["Produto", "Código/Cor", "Qtd.", "Unitário", "Total"]],
                body: tableRows,
                startY: 50,
                theme: 'grid',
                headStyles: { fillColor: [66, 66, 66], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 'auto' },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 30, halign: 'right' },
                    4: { cellWidth: 30, halign: 'right' }
                }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFillColor(240, 240, 240);
            doc.rect(14, finalY - 5, pageWidth - 28, 20, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`VALOR TOTAL: ${formatCurrency(totalOrder)}`, pageWidth - 20, finalY + 8, { align: 'right' });

            saveToHistory(items, totalOrder, month, today);

            return { doc, month, totalOrder };
        }

        // --- HISTÓRICO ---
        function saveToHistory(items, total, month, date) {
            const history = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            const newOrder = {
                id: Date.now(),
                date: date,
                month: month,
                total: total,
                itemCount: items.length
            };
            history.unshift(newOrder); 
            localStorage.setItem('orderHistory', JSON.stringify(history));
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            const tbody = elements.historyTable;
            tbody.innerHTML = '';

            if (history.length === 0) {
                elements.emptyHistoryMsg.classList.remove('hidden');
                return;
            }
            elements.emptyHistoryMsg.classList.add('hidden');

            history.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${order.month}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.itemCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-bold">${formatCurrency(order.total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteHistoryItem(${order.id})" class="text-red-600 hover:text-red-900 ml-3">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.deleteHistoryItem = function(id) {
            if(!confirm("Excluir este registro do histórico?")) return;
            let history = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            history = history.filter(h => h.id !== id);
            localStorage.setItem('orderHistory', JSON.stringify(history));
            renderHistory();
        };

        window.clearHistory = function() {
            if(!confirm("Apagar TODO o histórico?")) return;
            localStorage.removeItem('orderHistory');
            renderHistory();
        };

        // --- NOVA LÓGICA DE COMPARTILHAMENTO (WEB SHARE API) ---
        async function smartShare() {
            if (!currentPdfDoc) return;

            const blob = currentPdfDoc.doc.output('blob');
            const file = new File([blob], `Pedido_${currentPdfDoc.month}_ErikaDaiany.pdf`, { type: 'application/pdf' });
            
            const msg = `Bom dia ${CONTACT_NAME}, seguem em anexo o pedido ${currentPdfDoc.month}.`;

            // Tenta Compartilhamento Nativo (Mobile)
            if (navigator.share && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Pedido Studio Erika Daiany',
                        text: msg
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        // Se falhar (ex: desktop sem suporte), cai no fallback
                        fallbackDesktop(msg);
                    }
                }
            } else {
                // Fallback Desktop
                fallbackDesktop(msg);
            }
        }

        function fallbackDesktop(msg) {
            // 1. Baixa o arquivo
            downloadPdf();
            
            // 2. Abre o WhatsApp com a mensagem
            alert("O PDF foi baixado no seu computador.\n\nO WhatsApp Web será aberto agora. Por favor, arraste o arquivo PDF baixado para a conversa.");
            const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // --- AÇÕES DO MODAL ---
        function openPreview() {
            const result = preparePdf();
            if (!result) return;

            currentPdfDoc = result; 
            
            const pdfBlob = result.doc.output('blob');
            const blobUrl = URL.createObjectURL(pdfBlob);
            
            elements.modalFrame.src = blobUrl;
            elements.externalPdfLink.href = blobUrl;
            elements.modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            if (window.innerWidth < 640) {
                elements.modalFrame.classList.add('hidden');
                elements.mobilePlaceholder?.classList.remove('hidden');
            } else {
                elements.modalFrame.classList.remove('hidden');
                elements.mobilePlaceholder?.classList.add('hidden');
            }
        }

        window.closeModal = function() {
            elements.modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            elements.modalFrame.src = '';
        };

        function downloadPdf() {
            if (currentPdfDoc) {
                currentPdfDoc.doc.save(`Pedido_${currentPdfDoc.month}_ErikaDaiany.pdf`);
            }
        }

        // --- EVENT LISTENERS GLOBAIS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeState();
            renderLists();

            elements.searchInput.addEventListener('input', (e) => renderLists(e.target.value));
            elements.clearBtn.addEventListener('click', clearOrder);
            elements.previewBtn.addEventListener('click', openPreview);
            
            // Novos Botões
            elements.btnShareSmart.addEventListener('click', smartShare);
            elements.btnDownloadOnly.addEventListener('click', downloadPdf);
        });

    </script>
</body>
</html>